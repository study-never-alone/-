* 转自：知乎[Wang Hawk](https://zhuanlan.zhihu.com/p/51569883)
<article class="Post-Main Post-NormalMain" tabindex="-1"><header class="Post-Header"><h1 class="Post-Title">2. 从入射光到JPEG相片-数码相机内部的秘密</h1></div></div></div></div><div><span class="Voters"></span></div></header><div class="Post-RichTextContainer"><div class="RichText ztext Post-RichText"><p><b>【转载请注明来源和作者】</b></p><p>虽然你可能拥有不止一个相机，而且现在用手机也能拍出精彩的照片，但你肯定也曾困惑过，为什么数码相机(单反)，包括手机，可以拍出精彩的照片，它们跟传统的照相机到底区别在哪里？其实我自己也曾很困惑。我依稀记得我大学期间使用的相机都还是胶卷式的，怎么突然满大街都是数码相机和手机，人们甚至已经习惯了用手机来拍照，连数码相机都要被淘汰掉了似的。科技实在是进步得太快了。</p><p>现在让我们停下脚步，仔细的来探究一下，包括手机在内的数码摄影设备是如何将入射光转换为最终的JPEG格式的图片的。我会回答两个问题：</p><ol><li><b>RAW文件是如何生成的？</b></li><li><b>相机如何将RAW数据转换为最终我们看到的RGB图像（并存储为常见的JPG格式文件）</b></li></ol><p>下图正是照相机将入射光转换为“常规”图像的完整操作序列。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-1e22ecf7e847600c15533fa582cae5d9_b.jpg" data-caption="" data-size="normal" data-rawwidth="1356" data-rawheight="498" class="origin_image zh-lightbox-thumb" width="1356" data-original="https://pic2.zhimg.com/v2-1e22ecf7e847600c15533fa582cae5d9_r.jpg"/></noscript></figure><p>我们今天会谈到的内容有传感器(Sensor)，模拟前端(Analog front-end)，颜色滤镜(Color Filter)，相机内图像处理（红框内黄色部分）这几个主题。 </p><h2><b>一. RAW图像是如何得到的？</b></h2><p>让我们先看看现代数码相机的工作流程示意图。可以看到，从物体上传来的入射光通过相机的光学器件(蓝框部分）后会穿透颜色滤镜到达传感器，并通过模拟前端转化为数字信号（绿框部分），最后通过相机内的图像处理系统转换为最终的RGB格式图像，并存储为常见的JPG文件。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-9c90b77e5f9e0527d54190358509d5a9_b.jpg" data-caption="" data-size="normal" data-rawwidth="1498" data-rawheight="802" class="origin_image zh-lightbox-thumb" width="1498" data-original="https://pic2.zhimg.com/v2-9c90b77e5f9e0527d54190358509d5a9_r.jpg"/></noscript></figure><p>这一节我们先忽略光学部分，直接学习绿框部分的<b>传感器、模拟前端、颜色滤镜</b>，看看它们是如何将接收到的光线转换为RAW图像数据的。</p><h2><b>1. 传感器</b></h2><h2><b>1.1 传感器的基本组成</b></h2><p>正如下图所示，当相机的快门打开时入射光会穿过快门（通过镜头）到达传感器。此时到底会发生什么事？</p><p><br> </p><figure data-size="normal"><img src="https://pic3.zhimg.com/80/v2-a59ba7e84afc392a561b368cd81c7ea6_hd.jpg" data-size="normal" data-rawwidth="1928" data-rawheight="698" class="origin_image zh-lightbox-thumb lazy" width="1928" data-original="https://pic3.zhimg.com/v2-a59ba7e84afc392a561b368cd81c7ea6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-a59ba7e84afc392a561b368cd81c7ea6_b.jpg"><figcaption>快门关闭时</figcaption></figure><figure data-size="normal"><img src="https://pic1.zhimg.com/80/v2-4775e3998c15aee89b10b614f4624d28_hd.jpg" data-size="normal" data-rawwidth="1916" data-rawheight="702" class="origin_image zh-lightbox-thumb lazy" width="1916" data-original="https://pic1.zhimg.com/v2-4775e3998c15aee89b10b614f4624d28_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-4775e3998c15aee89b10b614f4624d28_b.jpg"><figcaption>快门打开时</figcaption></figure><p>正如让爱因斯坦在1921年获得诺贝尔奖的发现“<b>光电效应</b>”所揭示的，入射光子进入传感器后会转换为电子。因此，基本的传感器的设计如下图所示，其目的还是使得微透镜所汇聚的光子能被光电二极管转换为电子并存储在势阱中。</p><figure data-size="normal"><img src="https://pic1.zhimg.com/80/v2-7a4190bdf1ceac15bd0b7f00b052865c_hd.jpg" data-size="normal" data-rawwidth="596" data-rawheight="312" class="origin_image zh-lightbox-thumb lazy" width="596" data-original="https://pic1.zhimg.com/v2-7a4190bdf1ceac15bd0b7f00b052865c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-7a4190bdf1ceac15bd0b7f00b052865c_b.jpg"><figcaption>光电效应</figcaption></figure><p><br> </p><figure data-size="normal"><img src="https://pic3.zhimg.com/80/v2-258cf663d0082661ed1563657ff773ea_hd.jpg" data-size="normal" data-rawwidth="1148" data-rawheight="528" class="origin_image zh-lightbox-thumb lazy" width="1148" data-original="https://pic3.zhimg.com/v2-258cf663d0082661ed1563657ff773ea_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-258cf663d0082661ed1563657ff773ea_b.jpg"><figcaption>基本传感器设计</figcaption></figure><h2><b>1.2 传感器的性能衡量</b></h2><p>衡量一个传感器的性能的基本指标有：</p><ul><li><b>Photodiode quantum efficiency（QE）: 光电二极管量子效率</b></li><li><b>Photodiode response function：光电二极管响应函数</b></li><li><b>Photodiode full well capacity：光电二极管满阱容量</b></li></ul><p><b>量子效率</b> 是指转换的电子数量与入射的光子数量的比值</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-3f708d3c7d8e1e0dee543ec9e6c80761_b.jpg" data-size="normal" data-rawwidth="1148" data-rawheight="528" class="origin_image zh-lightbox-thumb" width="1148" data-original="https://pic3.zhimg.com/v2-258cf663d0082661ed1563657ff773ea_r.jpg"/></noscript><figcaption>量子效率(QE)</figcaption></figure><p>当不断改变入射光的强度时，转换的电子数量也会发生改变，这构成了上述所说的光电二极管的<b>响应函数</b>。通常来讲这是一个线性函数，如下图所示。 但当势阱饱和（过曝）或者光线过暗（噪声淹没了信号）时，它将不再是线性的。这个特性与后面之后会讲到的HDR图像的算法高度相关。</p><figure data-size="normal"><noscript></noscript><img src="https://pic4.zhimg.com/80/v2-338c985bac131a0f4502512e94c8ead3_hd.jpg" data-size="normal" data-rawwidth="854" data-rawheight="687" class="origin_image zh-lightbox-thumb lazy" width="854" data-original="https://pic4.zhimg.com/v2-338c985bac131a0f4502512e94c8ead3_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-338c985bac131a0f4502512e94c8ead3_b.jpg"><figcaption>光电二极管的响应函数</figcaption></figure><p>势阱的最大容量称为<b>满阱容量，</b><a href="https://link.zhihu.com/?target=http%3A//www.clarkvision.com/articles/digital.sensor.performance.summary/%23full_well" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">下图</a>显示了常见相机的传感器的满阱容量，由于硅中光子的有限和固定的吸收长度，满阱基本上是像素面积(而不是体积)的函数。</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-e40930a1a2836f15d88354d357a601fe_hd.jpg" data-size="normal" data-rawwidth="757" data-rawheight="546" class="origin_image zh-lightbox-thumb lazy" width="757" data-original="https://pic3.zhimg.com/v2-e40930a1a2836f15d88354d357a601fe_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-e40930a1a2836f15d88354d357a601fe_b.jpg"><figcaption>满井容量</figcaption></figure><h2><b>1.3 两种不同的传感器：CCD和CMOS</b></h2><p>根据读取电路的设计的不同，有两种不不同的传感器类型：CCD和CMOS。它们的区别可以用下表简要的概括。以前高端设备会采用CCD，而中低端、消费级产品才会采用CMOS。而现在的CMOS传感器已经和CCD传感器有相当的性能了，大多数消费级和工业摄像机已经采用了CMOS传感器。</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-185036e9e18ae61bc6c476c53bc37546_hd.jpg" data-size="normal" data-rawwidth="1556" data-rawheight="976" class="origin_image zh-lightbox-thumb lazy" width="1556" data-original="https://pic3.zhimg.com/v2-185036e9e18ae61bc6c476c53bc37546_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-185036e9e18ae61bc6c476c53bc37546_b.jpg"><figcaption>CCD和CMOS的比较</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p>仔细看看CCD和CMOS的结构图如下：</p><figure data-size="normal"><noscript></noscript><img src="https://pic2.zhimg.com/v2-bb1f7898fd8a28ca8e5f9280ce755cdd_b.jpg"  data-size="normal" data-rawwidth="860" data-rawheight="511" class="origin_image zh-lightbox-thumb lazy" width="860" data-original="https://pic2.zhimg.com/v2-bb1f7898fd8a28ca8e5f9280ce755cdd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-bb1f7898fd8a28ca8e5f9280ce755cdd_b.jpg"><figcaption>CCD</figcaption></figure><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-d16d1713007c89228b5de88313729ef6_hd.jpg" data-size="normal" data-rawwidth="860" data-rawheight="511" class="origin_image zh-lightbox-thumb lazy" width="860" data-original="https://pic3.zhimg.com/v2-d16d1713007c89228b5de88313729ef6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-d16d1713007c89228b5de88313729ef6_b.jpg"><figcaption>CMOS</figcaption></figure><h2><b>2. 模拟前端</b></h2><figure data-size="normal"><img src="https://pic1.zhimg.com/80/v2-a0116cfbbab88829b2dc7354a2bdc864_hd.jpg" data-size="normal" data-rawwidth="1470" data-rawheight="260" class="origin_image zh-lightbox-thumb lazy" width="1470" data-original="https://pic1.zhimg.com/v2-a0116cfbbab88829b2dc7354a2bdc864_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-a0116cfbbab88829b2dc7354a2bdc864_b.jpg"><figcaption>模拟前端</figcaption></figure><p>当相机镜头关闭时，模拟前端会从传感器的势阱中读出电子，并转换为模拟信号。这些信号首先被<b>Analog Amplifier(也称为Gain）</b>所放大。大家在相机设置中的ISO通常是会映射为对Gain的放大倍率的设置，而这个模块也跟后续会提到的相机的<b>Vignetting（渐晕）</b>高度相关。</p><p>放大后的模拟信号接下来由<b>Analog-to-Digital Converter(ADC)</b>转换为通常是10bits-16bits的数字信号，常见的为12bits。</p><p><b>Look-Up Table (LUT)</b>用于在一定的范围内修正传感器响应的非线性，这个模块同时还能够修复一些损坏的像素的输出。</p><p>我们上面提到了一种现象叫做Vignetting，它实际上是指生成的图像四周比中间暗，如下图所示：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-a36dfb822f5a59d7ec80b19ea3efbbb1_b.jpg" data-size="normal" data-rawwidth="100" data-rawheight="500" class="origin_image zh-lightbox-thumb lazy" width="500" data-original="https://pic2.zhimg.com/v2-a36dfb822f5a59d7ec80b19ea3efbbb1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-a36dfb822f5a59d7ec80b19ea3efbbb1_b.jpg"></noscript></figure><p>Vignetting的产生有多种原因，例如：</p><ul><li><b>机械原因：边缘的光线被滤镜遮挡</b></li><li><b>镜头原因：边缘光线被镜头内组件所遮挡</b></li><li><b>物理原因：光衰减与光入射到传感器阵列的角度的余弦的四次方成比例(cos4定律）</b></li><li><b>像素原因：在正常入射下入射到传感器上的光产生的信号比以斜角入射光的信号强。</b></li></ul><p>有了LUT，可以产生非线性的Gain从而纠正Vignetting现象</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-610a7b78a13abb934f1f1c5548c1fdc6_hd.jpg" data-size="normal" data-rawwidth="1496" data-rawheight="334" class="origin_image zh-lightbox-thumb lazy" width="1496" data-original="https://pic3.zhimg.com/v2-610a7b78a13abb934f1f1c5548c1fdc6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-610a7b78a13abb934f1f1c5548c1fdc6_b.jpg"><figcaption>纠正Vignetting</figcaption></figure><p>通过模拟前端生成的就是我们所说的<b>RAW格式图像</b>，后续的一系列处理都是基于RAW格式图像进行的。当然，不同的相机生产商会以不同的格式来存储RAW格式图像，大家可以查询到很多资料，推荐维基百科上的<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Raw_image_format" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">这一篇</a>，此处不再赘述。</p><h2><b>3. 颜色基础</b></h2><p>有没有记得前面曾经提到的颜色滤镜？这是起什么作用呢？</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-258cf663d0082661ed1563657ff773ea_hd.jpg" data-size="normal" data-rawwidth="1148" data-rawheight="528" class="origin_image zh-lightbox-thumb lazy" width="1148" data-original="https://pic3.zhimg.com/v2-258cf663d0082661ed1563657ff773ea_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-258cf663d0082661ed1563657ff773ea_b.jpg"><figcaption>基本传感器示意图</figcaption></figure><p>在进一步讲解之前，让我们先来了解一下颜色的基础知识。 </p><h2><b>3.1 颜色到底是什么？</b></h2><p>我们知道光是一种电磁波，而颜色并不是光的客观属性——光的客观属性是它的波长。下图展示了几乎完整的电磁波谱，而我们人眼所能看到的只是其中400nm到700nm的一小段，而颜色则是我们对这一小段电磁波的一种主观的感觉而已。</p><figure data-size="normal"><noscript></noscript><img src="https://pic4.zhimg.com/80/v2-dcd29e12a25b3217bdb35c011e768273_hd.jpg" data-size="normal" data-rawwidth="1380" data-rawheight="738" class="origin_image zh-lightbox-thumb lazy" width="1380" data-original="https://pic4.zhimg.com/v2-dcd29e12a25b3217bdb35c011e768273_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-dcd29e12a25b3217bdb35c011e768273_b.jpg"><figcaption>电磁波谱</figcaption></figure><p>这种主观的感觉既跟入射光的<b>功率谱分布（SPD）</b>相关，也跟人眼对不同光源的<b>光谱敏感度</b>相关，我们分别来探讨下这两个概念。</p><h2><b>3.2 光源的功率谱分布（Spectral Power Distribution - SPD)</b></h2><p>通常的光源都由多个波长的光组成，而每一种波长的光的功率一般都不一样。如果画出每种波长的功率和它的波长之间的关系，我们可以得到光源的<b>功率谱分布（SPD）</b>。例如下图展示了几种光源的SPD</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript></noscript><img src="https://pic4.zhimg.com/80/v2-b83c4b05c15d2b78b2eefce199da96cf_hd.jpg" data-size="normal" data-rawwidth="1264" data-rawheight="682" class="origin_image zh-lightbox-thumb lazy" width="1264" data-original="https://pic4.zhimg.com/v2-b83c4b05c15d2b78b2eefce199da96cf_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-b83c4b05c15d2b78b2eefce199da96cf_b.jpg"><figcaption>功率谱分布（SPD）</figcaption></figure><h2><b>3.3 传感器的光谱敏感度函数（Spectral Sensitivity Function - SSF）</b></h2><p>不管是数字的还是非数字的传感器，它们对不同波长的入射光线会有不同的敏感度，可以用传感器的<b>谱敏感度函数（SSF）</b>来衡量。传感器对入射光的响应是一个累加了所有光波响应的单一的值，我们可以用一个积分表达式来描述：</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-fd2be07620c8b995a5e2d2757b77b7a2_hd.jpg" data-size="normal" data-rawwidth="982" data-rawheight="266" class="origin_image zh-lightbox-thumb lazy" width="982" data-original="https://pic3.zhimg.com/v2-fd2be07620c8b995a5e2d2757b77b7a2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-fd2be07620c8b995a5e2d2757b77b7a2_b.jpg"><figcaption>传感器响应是入射光SPD与传感器本身的光谱敏感度函数乘积的积分</figcaption></figure><p class="ztext-empty-paragraph"><br></p><p><b>那么人眼呢？</b>实际上人眼是由包含对不同光波敏感的三种视锥细胞，最终的感觉是由这三种细胞的响应共同构成的，如下公式所示。</p><figure data-size="normal"><img src="https://pic1.zhimg.com/80/v2-4930aba8cbae90028a84e1997b693250_hd.jpg" data-size="normal" data-rawwidth="501" data-rawheight="425" class="origin_image zh-lightbox-thumb lazy" width="501" data-original="https://pic1.zhimg.com/v2-4930aba8cbae90028a84e1997b693250_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-4930aba8cbae90028a84e1997b693250_b.jpg"><figcaption>三种细胞的响应函数</figcaption></figure><h2><b>3.4 颜色滤光阵列(Color Filter Array)</b></h2><p>现在我们回到相机的传感器就明白了，为了能在最终的相片中加入颜色信息，人们用颜色滤镜来模拟了不同的视锥细胞。当这些颜色滤镜以预先设定好的形式排列时，就构成了<b>颜色滤光阵列(Color Filter Array)</b>。</p><p>这里面牵涉两个问题，第一是如何设计滤光镜对不同光线的敏感度，第二是如何设计不同的颜色滤光镜的最佳空间排列（也成为Mosaic)。</p><p>下图是Canon 40D和50D的谱敏感函数图比较。每个相机厂商，甚至是同一厂商的不同型号的相机的传感器的SSF都可能不同</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-22689fda4998ae02b4260342b7429272_hd.jpg" data-size="normal" data-rawwidth="652" data-rawheight="626" class="origin_image zh-lightbox-thumb lazy" width="652" data-original="https://pic3.zhimg.com/v2-22689fda4998ae02b4260342b7429272_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-22689fda4998ae02b4260342b7429272_b.jpg"><figcaption>Canon 40D 和 Canon 50D 的SSF不同</figcaption></figure><p>下图是一些Mosaic设计，其中我们最常用最基础的是<b>Bayer Mosaic。</b></p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-9a10126188ea02f3c47370d123b44e86_hd.jpg" data-caption="" data-size="normal" data-rawwidth="1826" data-rawheight="829" class="origin_image zh-lightbox-thumb lazy" width="1826" data-original="https://pic3.zhimg.com/v2-9a10126188ea02f3c47370d123b44e86_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-9a10126188ea02f3c47370d123b44e86_b.jpg"></figure><p>因此，当光线通过颜色滤光镜到达传感器，由模拟前端最终转换为数字RAW图像时，图像会变成什么样呢？可以看到RAW图像并未显示出颜色，反而显示出马赛克一样的方块，并且还有大量的噪声。所以，接下来很重要的就是通过相机内的图像处理系统对图像进行一系列处理，来使之变成最终美观的RGB图像。</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-2cb2478c7c7754f25c7b5eb4c25abd2a_hd.jpg" data-size="normal" data-rawwidth="1727" data-rawheight="826" class="origin_image zh-lightbox-thumb lazy" width="1727" data-original="https://pic3.zhimg.com/v2-2cb2478c7c7754f25c7b5eb4c25abd2a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-2cb2478c7c7754f25c7b5eb4c25abd2a_b.jpg"><figcaption>RAW图像上的噪声和马赛克效应</figcaption></figure><p><b>二. 相机如何将RAW数据转换为最终我们看到的RGB图像?</b></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-1e22ecf7e847600c15533fa582cae5d9_b.jpg" data-size="normal" data-rawwidth="1356" data-rawheight="498" class="origin_image zh-lightbox-thumb" width="1356" data-original="https://pic2.zhimg.com/v2-1e22ecf7e847600c15533fa582cae5d9_r.jpg"/></noscript><figcaption>相机内基本处理流程</figcaption></figure><h2><b>1. 白平衡(White Balance)</b></h2><p>前面讲过，颜色是我们对光的一种主观感受，它直接与我们人眼的SSF以及入射光的SPD相关，那么除此之外，是否跟别的因素相关呢？的确如此，从下图可以看到我们人眼对不同环境光线下拍摄的物体的颜色具有自纠正的作用。</p><figure data-size="normal"><noscript></noscript><img src="https://pic2.zhimg.com/80/v2-39c58d020a46fa24cd98f666a53cfcb1_r.jpg" data-caption="" data-size="normal" data-rawwidth="500" data-rawheight="511" class="origin_image zh-lightbox-thumb lazy" width="500" data-original="https://pic2.zhimg.com/v2-39c58d020a46fa24cd98f666a53cfcb1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-39c58d020a46fa24cd98f666a53cfcb1_b.jpg"></figure><p class="ztext-empty-paragraph"><br></p><p>但相机不具备这样的功能，因此如果不经过颜色的校正，拍出来的图片的颜色就会很失真。这就是白平衡的作用：它使得我们人眼感知为白色的物体在最终的成像中也为白色。</p><figure data-size="normal"><img src="https://pic4.zhimg.com/80/v2-765518c5eb3bb2a6899518906fce45b7_hd.jpg" data-caption="" data-size="normal" data-rawwidth="1535" data-rawheight="511" class="origin_image zh-lightbox-thumb lazy" width="1535" data-original="https://pic4.zhimg.com/v2-765518c5eb3bb2a6899518906fce45b7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-765518c5eb3bb2a6899518906fce45b7_b.jpg"></figure><p>现在大家用普通的相机一般都会内置一些白平衡选项，可以根据自己的喜好和环境的光线选择合适的白平衡选项进行颜色的矫正：</p><figure data-size="normal"><img src="https://pic4.zhimg.com/80/v2-0ce6fc863911a3624da6707ae0564ff7_hd.jpg" data-size="normal" data-rawwidth="1290" data-rawheight="539" class="origin_image zh-lightbox-thumb lazy" width="1290" data-original="https://pic4.zhimg.com/v2-0ce6fc863911a3624da6707ae0564ff7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-0ce6fc863911a3624da6707ae0564ff7_b.jpg"><figcaption>相机上预设的白平衡设置</figcaption></figure><p>实际上，自动白平衡是一个很热门的研究领域，这里我们介绍两种基本的白平衡算法。正如前面所讲，白平衡是要使得我们人眼感知到的白色最后成像也是白色，那么首先就要确定图像中哪些是白色。这里有两种假设</p><ul><li><b>灰色世界假设（Gray World      Assumption)</b></li></ul><p>它假设图像的平均颜色是白色，其基本的算法可以用如下公式表示</p><figure data-size="normal"><img src="https://pic3.zhimg.com/80/v2-5461ec0e8e38825a49163eb0db6dc0c6_hd.png" data-caption="" data-size="normal" data-rawwidth="1749" data-rawheight="253" class="origin_image zh-lightbox-thumb lazy" width="1749" data-original="https://pic3.zhimg.com/v2-5461ec0e8e38825a49163eb0db6dc0c6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-5461ec0e8e38825a49163eb0db6dc0c6_b.png"></figure><ul><li><b>白世界假设(While World      Assumption)</b></li></ul><p>它假设图像中最亮的区域是白色，公式如下：</p><figure data-size="normal"><img src="https://pic2.zhimg.com/80/v2-0834e4857dd8cd40e3a8870191dc2165_hd.png" data-caption="" data-size="normal" data-rawwidth="1749" data-rawheight="250" class="origin_image zh-lightbox-thumb lazy" width="1749" data-original="https://pic2.zhimg.com/v2-0834e4857dd8cd40e3a8870191dc2165_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-0834e4857dd8cd40e3a8870191dc2165_b.png"></figure><p>我们会在之后用实际代码来验证这两者的不同。但如果大家观察上述公式会发现，白平衡算法的前提是要能够获取不同通道的数据，但我们前面已经讲过，RAW格式图像实际上是不带颜色的数据。那么从RAW格式图像中分离三个通道的数据，就是所谓的Demosaicing的过程。</p><h2><b>2. 去马赛克(Demosaicing）</b></h2><p>在去马赛克之前，每个像素只有一个单一的颜色，而我们是想恢复完整的颜色，如何做到呢？</p><figure data-size="normal"><img src="https://pic4.zhimg.com/80/v2-8cabd68315719c841eac55c62c6b8eef_hd.jpg" data-caption="" data-size="normal" data-rawwidth="1000" data-rawheight="313" class="origin_image zh-lightbox-thumb lazy" width="1000" data-original="https://pic4.zhimg.com/v2-8cabd68315719c841eac55c62c6b8eef_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-8cabd68315719c841eac55c62c6b8eef_b.jpg"></figure><p>基本上这是通过“插值”来完成的。 常见的插值方法有：</p><ul><li>Bilinear插值</li><li>Bicubic插值</li><li>Edge-Aware插值</li></ul><p>这里我们介绍只需要像素的四个领域即可完成的Bilinear插值，简单讲只需将同一颜色的四个领域取平均值即可：</p><figure data-size="normal"><img src="https://pic4.zhimg.com/80/v2-e535ece48587e129989fd9aa360aa20f_hd.jpg" data-caption="" data-size="normal" data-rawwidth="1366" data-rawheight="284" class="origin_image zh-lightbox-thumb lazy" width="1366" data-original="https://pic4.zhimg.com/v2-e535ece48587e129989fd9aa360aa20f_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-e535ece48587e129989fd9aa360aa20f_b.jpg"></figure><p>而对于不同的颜色通道则独立的重复这一过程</p><figure data-size="normal"><img src="https://pic1.zhimg.com/80/v2-6e7b741dd1e88ebf252199fba8edc3e0_hd.jpg" data-caption="" data-size="normal" data-rawwidth="1348" data-rawheight="274" class="origin_image zh-lightbox-thumb lazy" width="1348" data-original="https://pic1.zhimg.com/v2-6e7b741dd1e88ebf252199fba8edc3e0_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-6e7b741dd1e88ebf252199fba8edc3e0_b.jpg"></figure><h2><b>3. 去噪(Denoising)</b></h2><p>如下图所示，未经去噪处理前的图像通常会包含很多噪声，尤其是在低光环境下。</p><p>噪声的来源是多样的，例如：</p><ul><li><b>散粒噪声：由光子到达传感器的数量分布的</b></li></ul><figure data-size="normal"><img src="https://pic1.zhimg.com/80/v2-78f9ec3750955f32bc539d50bb590914_hd.jpg" data-size="normal" data-rawwidth="1932" data-rawheight="638" class="origin_image zh-lightbox-thumb lazy" width="1932" data-original="https://pic1.zhimg.com/v2-78f9ec3750955f32bc539d50bb590914_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-78f9ec3750955f32bc539d50bb590914_b.jpg"><figcaption>图像上的噪声</figcaption></figure><p>随机性导致，场景越量，这种随机分布的方差越小，越不容易产生噪声。对于比较明亮的场景以及较大像素尺寸的传感器，散粒噪声是最主要的噪声来源。</p><ul><li><b>暗粒噪声：传感器发热导致逸出电子从而产生的噪声，温度越高，噪声越大</b></li><li><b>读取噪声：由于读取电路引起的噪声</b> </li></ul><p>那么如何去噪呢？我们这里谈论的是相机内的去噪算法，由于大部分相机本身的运算能力不高，这也意味着无法选择很复杂的不利于硬件化的算法。这里简单用下面这页图来展示均值滤波和中值滤波，以后还会给大家介绍更多的去噪算法。</p><figure data-size="normal"><noscript></noscript><img src="https://pic2.zhimg.com/80/v2-22eb294d0a48dd7babdfd18271e7f34d_r.jpg" data-caption="" data-size="normal" data-rawwidth="2000" data-rawheight="1109" class="origin_image zh-lightbox-thumb lazy" width="2000" data-original="https://pic2.zhimg.com/v2-22eb294d0a48dd7babdfd18271e7f34d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-22eb294d0a48dd7babdfd18271e7f34d_b.jpg"></figure><h2><b>4. 色调重建(Tone reproduction）</b></h2><p>现在我们来谈一个很重要的问题：<b>色调重建，也叫做Gamma校正。</b></p><p>我们已经知道，传感器对输入图像的响应大部分是线性的，而且我们人眼对输入光的响应也是线性的。然而，人的感觉却是非线性的，即人对暗光会更加敏感，而这种感觉上的敏感度很接近Gamma函数。与此同时，我们的传统CRT显示设备相对输入图像通常也是非线性的，其对输入的敏感性和人眼的特性恰好相反。这两种效应的共同作用，会使得我们大脑感知到的图像显得很暗。</p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript></noscript><img src="https://pic4.zhimg.com/80/v2-edfb1bf1b692b0b6d9d720db514378fb_hd.jpg" data-size="normal" data-rawwidth="1932" data-rawheight="401" class="origin_image zh-lightbox-thumb lazy" width="1932" data-original="https://pic4.zhimg.com/v2-edfb1bf1b692b0b6d9d720db514378fb_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-edfb1bf1b692b0b6d9d720db514378fb_b.jpg"><figcaption>人眼的响应特性</figcaption></figure><p><br> </p><figure data-size="normal"><noscript></noscript><img src="https://pic2.zhimg.com/80/v2-257d83c0f5be4cb51bb1d72e0d1981ad_r.jpg" data-size="normal" data-rawwidth="1122" data-rawheight="508" class="origin_image zh-lightbox-thumb lazy" width="1122" data-original="https://pic2.zhimg.com/v2-257d83c0f5be4cb51bb1d72e0d1981ad_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-257d83c0f5be4cb51bb1d72e0d1981ad_b.jpg"><figcaption>相机的原始响应是线性的，但是人眼和显示器却是非线性的</figcaption></figure><p>我们解决此问题的办法，是在相机内部对图像做一次Gamma校正，用于抵消显示器的显示效应。如果原图的线性响应值是L，那么新的图像会是 <img src="https://www.zhihu.com/equation?tex=L%5E%7B%5Cfrac%7B1%7D%7B%5Cgamma%7D%7D" alt="L^{\frac{1}{\gamma}}" eeimg="1"> , <img src="https://www.zhihu.com/equation?tex=%5Cgamma" alt="\gamma" eeimg="1"> 一般取2.2.</p><figure data-size="normal"><noscript></noscript><img src="https://pic2.zhimg.com/80/v2-e43329561657a3bade68bb82d3c08eb9_hd.jpg" data-caption="" data-size="normal" data-rawwidth="926" data-rawheight="324" class="origin_image zh-lightbox-thumb lazy" width="926" data-original="https://pic2.zhimg.com/v2-e43329561657a3bade68bb82d3c08eb9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-e43329561657a3bade68bb82d3c08eb9_b.jpg"></figure><p>gamma校正一般在哪个阶段进行呢？可不可以在拍摄的过程中不进行gamma校正，只是保存图像为jpeg形式，在下一次显示之前才做呢？ 通常来说不宜这样，因为当我们把图像保存为jpeg形式是会进行位空间压缩，这会导致信息损失。所以最好是在压缩前就做好gamma校正。大家注意回顾gamma校正的位置：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-1e22ecf7e847600c15533fa582cae5d9_b.jpg" data-caption="" data-size="normal" data-rawwidth="1356" data-rawheight="498" class="origin_image zh-lightbox-thumb" width="1356" data-original="https://pic2.zhimg.com/v2-1e22ecf7e847600c15533fa582cae5d9_r.jpg"/></noscript></figure><h2><b>三、raw图像的获取和处理</b></h2><p>到此为止，我相信你已经对我阐述过的模块有了基本的理解。我特意忽略掉了色彩转换这一部分，因为关于颜色我会用专门的文章来做深入的探讨。 </p><p>此时让我们来尝试仿真从入射光到最终的jpg图像的全过程, 我会把实例仿真分为两个部分：</p><ol><li>获取RAW图像</li><li>用dcraw转换raw图像</li></ol><h2><b>1. 获取RAW图像</b></h2><p>当我们谈到获取RAW图像时，先回答一个问题：为什么我们需要RAW图像？我们平时用相机拍摄并存储的JPEG图像文件不够好吗？</p><p>事实上，JPEG是图像压缩后的存储格式，解压后是RGB图像，它本身正如上面所讲是非线性的，这使得很多计算摄影相关的算法直接作用到RGB图像上都会产生错误的结果，例如photometric stereo, shape from shading, image-based relighting, illumination estimation, 包括与光传输和反向渲染有关的任何算法。这时候，最佳的解决方案就是采用线性的RAW图像来替代。</p><p class="ztext-empty-paragraph"><br></p><p>那么如何获取到RAW图像呢？很简单，大部分单反在拍摄时都可以选择保存RAW图像文件。当然每个相机厂商都有自己不同的存储RAW图像的格式，例如Canon的RAW文件格式是CR2，是一种遵循TIFF规范的14bit的RAW文件。<a href="https://link.zhihu.com/?target=https%3A//cpn.canon-europe.com/content/education/infobank/image_compression/how_to_set_raw_jpeg.do" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">这里</a>可以查到更多的信息。</p><p class="ztext-empty-paragraph"><br></p><p>假如你使用手机拍摄呢？你还可以使用lightroom这一款应用，不过注意并不是每一款手机都支持。你可以在<a href="https://link.zhihu.com/?target=https%3A//helpx.adobe.com/cn/lightroom/help/work-with-lightroom-mobile-android.html" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">这里</a>查到更多的信息。</p><h2><b>2 用dcraw转换raw图像</b></h2><p>RAW格式文件是否可以直接用Matlab、Python或别的开发工具打开？事实上并不能直接打开。虽然有很多方法可以解决此问题，但这里推荐的一种方法是利用dcraw这个小软件来将RAW格式文件转换为TIFF文件，而后者时可以直接被很多图像处理软件打开的。dcraw的官网在这里：<a href="https://link.zhihu.com/?target=http%3A//www.cybercom.net/~dcoffin/dcraw/" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">http://www.</span><span class="visible">cybercom.net/~dcoffin/d</span><span class="invisible">craw/</span><span class="ellipsis"></span></a>，它由很多可选的参数。</p><p>为了3.3节仿真相机内的处理流程，我用下面的命令将一个CR2格式的RAW文件转换为对应的TIFF文件，并确保后者未经过相机内的任何处理，只包含原始信息。</p><div class="highlight"><pre><code class="language-text">dcraw -4 -D -T &lt;RAW_filename&gt; </code></pre></div><p>dcraw非常强大，可以模拟相机内的的大部分标准流程。例如-a选项就可以模拟用全图信息做灰度世界的白平衡，-q可以用于控制demosaicing的插值质量等等。看官可以自行探索。</p><p>例如，我可以用dcraw -4 -D -T banana_slug.cr2轻松的将附件RAW文件转换为了banana_slug.tiff文件，后续就可以用任意一种开发语言来处理它。</p><h2><b>四、总结</b></h2><p>从入射光到最终的相片，相机拍照的过程是非常复杂的，我们今天的内容对这个过程的大部分基本模块进行了介绍。但是需要注意的是，每个相机厂商都会设计自己私有的、非常复杂的In Camera Image Process Pipeline，很多时候通过最终的成像是完全无法知道其内部到底有哪些私有操作、以及这些操作的顺序的。</p><p class="ztext-empty-paragraph"><br></p><p>如下是这个帖子的核心内容总结，希望本文对你所有帮助，谢谢。</p><figure data-size="normal"><noscript></noscript><img src="https://pic3.zhimg.com/80/v2-ef07409f0b4de09cd7d60de46adf74a2_hd.jpg" data-caption="" data-size="normal" data-rawwidth="1096" data-rawheight="756" class="origin_image zh-lightbox-thumb lazy" width="1096" data-original="https://pic3.zhimg.com/v2-ef07409f0b4de09cd7d60de46adf74a2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-ef07409f0b4de09cd7d60de46adf74a2_b.jpg"></figure><p>我在如下的Jupyter Notebook中展示了本帖中的相关操作，你可以对着它获取更深入的理解，也能够进一步掌握用Python来进行图像处理的一些技巧。</p><p><b><a href="https://link.zhihu.com/?target=http%3A//nbviewer.jupyter.org/github/yourwanghao/CMUComputationalPhotography/blob/master/class2/notebook2.ipynb" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">http://</span><span class="visible">nbviewer.jupyter.org/gi</span><span class="invisible">thub/yourwanghao/CMUComputationalPhotography/blob/master/class2/notebook2.ipynb</span><span class="ellipsis"></span></a></b></p><p>跟这一系列专题文章相关的Notebook可以从下面的仓库获取</p><div class="highlight"><pre><code class="language-text">https://github.com/yourwanghao/CMUComputationalPhotography.git</code></pre></div><h2><b>参考资料：</b></h2><p>这一篇文章的绝大部分素材来自于</p><p>[1] <a href="https://link.zhihu.com/?target=http%3A//graphics.cs.cmu.edu/courses/15-463/2017_fall/lectures/lecture2.pptx" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">CMU 2017 Fall Computational Photography Course 15-463, Lecture 2</a></p><p>如果不做特别说明，素材均来自于[1]</p><p>我也会参考下面的重要资料中的内容</p><p>[2] Richard Szeliski, Computer Vision : Algorithms and Applications, </p><p>[3] Michael Brown, “<a href="https://link.zhihu.com/?target=http%3A//www.comp.nus.edu.sg/~brown/CVPR2016_Brown.html" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">Understanding the In-Camera Image Processing Pipeline for Computer Vision</a>,” CVPR 2016</p></div></div><div class="ContentItem-time">编辑于 2019-04-21</div><div class="Post-topicsAndReviewer"><div class="TopicList Post-Topics"><div class="Tag Topic" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19590195&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="//www.zhihu.com/topic/19590195" target="_blank"><div class="Popover"><div id="Popover4-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover4-content">计算机视觉</div></div></a></span></div><div class="Tag Topic" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;20005694&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="//www.zhihu.com/topic/20005694" target="_blank"><div class="Popover"><div id="Popover5-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover5-content">Computational photography</div></div></a></span></div><div class="Tag Topic" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19613730&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="//www.zhihu.com/topic/19613730" target="_blank"><div class="Popover"><div id="Popover6-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover6-content">计算机图形学</div></div></a></span></div></div></div><div><div class="Sticky RichContent-actions is-fixed is-bottom" style="width: 690px; bottom: 0px; left: 16px;"><div class="ContentItem-actions" data-za-detail-view-path-module="BottomBar" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;id&quot;:&quot;51569883&quot;}}}"><span><button aria-label="赞同 215" type="button" class="Button VoteButton VoteButton--up"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--TriangleUp VoteButton-TriangleUp" fill="currentColor" viewBox="0 0 24 24" width="10" height="10"><path d="M2 18.242c0-.326.088-.532.237-.896l7.98-13.203C10.572 3.57 11.086 3 12 3c.915 0 1.429.571 1.784 1.143l7.98 13.203c.15.364.236.57.236.896 0 1.386-.875 1.9-1.955 1.9H3.955c-1.08 0-1.955-.517-1.955-1.9z" fill-rule="evenodd"></path></svg></span>赞同 215</button><button aria-label="反对" type="button" class="Button VoteButton VoteButton--down"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--TriangleDown" fill="currentColor" viewBox="0 0 24 24" width="10" height="10"><path d="M20.044 3H3.956C2.876 3 2 3.517 2 4.9c0 .326.087.533.236.896L10.216 19c.355.571.87 1.143 1.784 1.143s1.429-.572 1.784-1.143l7.98-13.204c.149-.363.236-.57.236-.896 0-1.386-.876-1.9-1.956-1.9z" fill-rule="evenodd"></path></svg></span></button></span><button type="button" class="Button BottomActions-CommentBtn Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Comment Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M10.241 19.313a.97.97 0 0 0-.77.2 7.908 7.908 0 0 1-3.772 1.482.409.409 0 0 1-.38-.637 5.825 5.825 0 0 0 1.11-2.237.605.605 0 0 0-.227-.59A7.935 7.935 0 0 1 3 11.25C3 6.7 7.03 3 12 3s9 3.7 9 8.25-4.373 9.108-10.759 8.063z" fill-rule="evenodd"></path></svg></span>40 条评论</button><div class="Popover ShareMenu"><div class="ShareMenu-toggler" id="Popover7-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover7-content"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Share Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M2.931 7.89c-1.067.24-1.275 1.669-.318 2.207l5.277 2.908 8.168-4.776c.25-.127.477.198.273.39L9.05 14.66l.927 5.953c.18 1.084 1.593 1.376 2.182.456l9.644-15.242c.584-.892-.212-2.029-1.234-1.796L2.93 7.89z" fill-rule="evenodd"></path></svg></span>分享</button></div></div><button type="button" class="Button ContentItem-action Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Star Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M5.515 19.64l.918-5.355-3.89-3.792c-.926-.902-.639-1.784.64-1.97L8.56 7.74l2.404-4.871c.572-1.16 1.5-1.16 2.072 0L15.44 7.74l5.377.782c1.28.186 1.566 1.068.64 1.97l-3.89 3.793.918 5.354c.219 1.274-.532 1.82-1.676 1.218L12 18.33l-4.808 2.528c-1.145.602-1.896.056-1.677-1.218z" fill-rule="evenodd"></path></svg></span>收藏</button><div class="Post-ActionMenuButton"><div class="Popover"><div id="Popover8-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover8-content"><button type="button" class="Button Button--plain Button--withIcon Button--iconOnly"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Dots Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M5 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm7 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm7 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4z" fill-rule="evenodd"></path></svg></span></button></div></div></div></div><div data-za-detail-view-path-module="LeftTabBar" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;id&quot;:&quot;51569883&quot;}}}"></div></div><div class="Sticky--holder" style="position: static; top: auto; right: auto; bottom: 0px; left: 0px; display: block; float: none; margin: 0px 0px 10px; height: 54px;"></div></div></article>
